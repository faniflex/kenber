<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Smart Irrigation - Home</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root {
      --bg-light: #ffffff;
      --text-light: #212529;
      --bg-dark: #212529;
      --text-dark: #f8f9fa;
    }

    [data-theme="dark"] {
      background-color: var(--bg-dark);
      color: var(--text-dark);
    }

    .theme-card {
      background-color: var(--bg-light);
      border-radius: 15px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    [data-theme="dark"] .theme-card {
      background-color: #343a40;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .bottom-nav {
      background-color: var(--bg-light);
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      height: 60px;
    }

    [data-theme="dark"] .bottom-nav {
      background-color: #343a40;
    }

    .nav-icon {
      font-size: 1.5rem;
      color: #6c757d;
      transition: all 0.2s ease;
    }

    .nav-icon.active {
      color: #13d755;
      transform: scale(1.2);
    }

    .update-time {
      font-size: 0.875rem;
      color: #6c757d;
    }
    
    /* New styles for additional content */
    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 6px;
    }
    
    .status-active {
      background-color: #13d755;
    }
    
    .status-idle {
      background-color: #6c757d;
    }
    
    .water-usage-card {
      position: relative;
      overflow: hidden;
    }
    
    .water-drop {
      position: absolute;
      width: 100px;
      height: 100px;
      background-color: rgba(19, 215, 85, 0.1);
      border-radius: 50%;
      top: -30px;
      right: -30px;
    }
    
    .system-health {
      height: 8px;
      border-radius: 4px;
      background-color: #e9ecef;
      overflow: hidden;
    }
    
    .health-bar {
      height: 100%;
      background-color: #13d755;
      width: 95%;
    }
    
    .quick-action-btn {
      border-radius: 12px;
      padding: 10px 15px;
      font-size: 0.9rem;
    }
    
    .progress-thin {
      height: 6px;
    }
  </style>
</head>
<body>

<div class="container py-4">
  <!-- Theme Toggle -->
  <div class="d-flex justify-content-end mb-2">
    <button class="btn btn-link" id="themeToggle">
      <i class="bi" id="themeIcon"></i>
    </button>
  </div>

  <!-- Welcome Message -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="mb-0 fw-semibold" id="welcomeMessage">Welcome!</h4>
    <div class="system-health">
      <div class="health-bar"></div>
    </div>
  </div>

  <!-- Real-time Status Board -->
  <div class="row mb-4">
    <div class="col-6 col-md-3 mb-3">
      <div class="card theme-card text-center p-2">
        <div class="card-body">
          <i class="bi bi-moisture fs-4"></i>
          <h6 class="my-1">Soil Moisture</h6>
          <h4 class="mb-0" id="soilMoisture">--%</h4>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3 mb-3">
      <div class="card theme-card text-center p-2">
        <div class="card-body">
          <i class="bi bi-thermometer-half fs-4"></i>
          <h6 class="my-1">Temperature</h6>
          <h4 class="mb-0" id="temperature">--Â°C</h4>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3 mb-3">
      <div class="card theme-card text-center p-2">
        <div class="card-body">
          <i class="bi bi-droplet-half fs-4"></i>
          <h6 class="my-1">Humidity</h6>
          <h4 class="mb-0" id="humidity">--%</h4>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3 mb-3">
      <div class="card theme-card text-center p-2">
        <div class="card-body">
          <i class="bi bi-power fs-4"></i>
          <h6 class="my-1">Pump Status</h6>
          <h4 class="mb-0" id="pumpStatus">--</h4>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card theme-card p-3">
        <h6 class="mb-3">Quick Actions</h6>
        <div class="d-flex justify-content-between">
          <button class="btn btn-outline-success quick-action-btn" id="waterNowBtn">
            <i class="bi bi-droplet-fill me-2"></i>Water Now
        </div>
      </div>
    </div>
  </div>

  <!-- Water Usage -->
  <div class="row mb-4">
    <div class="col-md-6 mb-3">
      <div class="card theme-card p-3 water-usage-card">
        <div class="water-drop"></div>
        <h6 class="mb-3">Water Usage</h6>
        <div class="mb-3">
          <div class="d-flex justify-content-between mb-1">
            <span>Today</span>
            <span id="todayUsage">0L</span>
          </div>
          <div class="progress progress-thin">
            <div class="progress-bar bg-success" id="todayProgress" role="progressbar" style="width: 0%"></div>
          </div>
        </div>
        <div class="mb-3">
          <div class="d-flex justify-content-between mb-1">
            <span>This Week</span>
            <span id="weekUsage">0L</span>
          </div>
          <div class="progress progress-thin">
            <div class="progress-bar bg-info" id="weekProgress" role="progressbar" style="width: 0%"></div>
          </div>
        </div>
        <div>
          <div class="d-flex justify-content-between mb-1">
            <span>This Month</span>
            <span id="monthUsage">0L</span>
          </div>
          <div class="progress progress-thin">
            <div class="progress-bar bg-primary" id="monthProgress" role="progressbar" style="width: 0%"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-6 mb-3">
      <div class="card theme-card p-3">
        <h6 class="mb-3">System Status</h6>
        <div class="mb-2 d-flex justify-content-between">
          <span><span class="status-indicator status-active"></span>Main Controller</span>
          <small class="text-success">Online</small>
        </div>
        <div class="mb-2 d-flex justify-content-between">
          <span><span class="status-indicator status-active"></span>Moisture Sensor</span>
          <small class="text-success">Online</small>
        </div>
        <div class="mb-2 d-flex justify-content-between">
          <span><span class="status-indicator status-active"></span>Water Pump</span>
          <small class="text-success">Online</small>
        </div>
        <div class="mb-2 d-flex justify-content-between">
          <span><span class="status-indicator status-idle"></span>Weather API</span>
          <small class="text-muted">Disabled</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Last Updated -->
  <p class="text-center update-time">Last Updated: <span id="lastUpdated">--:--:--</span></p>
  
  <!-- Tips Section -->
  <div class="card theme-card p-3 mb-4">
    <h6 class="mb-3"><i class="bi bi-lightbulb me-2"></i>Watering Tip</h6>
    <p class="mb-0" id="wateringTip">Early morning watering reduces evaporation and helps prevent plant diseases.</p>
  </div>
</div>

<!-- Bottom Navigation -->
<nav class="navbar fixed-bottom bottom-nav p-2">
  <div class="d-flex justify-content-around w-100">
    <a href="home.html"><i class="bi bi-house-door-fill nav-icon active"></i></a>
    <a href="control.html"><i class="bi bi-sliders nav-icon"></i></a>
    <a href="news.html"><i class="bi bi-graph-up nav-icon"></i></a>
    <a href="notification.html"><i class="bi bi-chat-dots nav-icon"></i></a>
    <a href="settings.html"><i class="bi bi-gear nav-icon"></i></a>
  </div>
</nav>

<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    const body = document.body;

    // Water usage tracking variables
    let waterUsage = {
      today: 0,       // in liters
      week: 0,        // in liters
      month: 0,       // in liters
      lastUpdated: null,
      pumpActive: false,
      pumpStartTime: null,
      flowRate: 2.5   // liters per minute (adjust based on your pump)
    };

    // Load saved water usage from localStorage
    function loadWaterUsage() {
      const savedUsage = localStorage.getItem('waterUsage');
      if (savedUsage) {
        const parsed = JSON.parse(savedUsage);
        
        // Check if the saved data is from today
        const today = new Date().toDateString();
        if (parsed.lastUpdated === today) {
          waterUsage.today = parsed.today || 0;
          waterUsage.week = parsed.week || 0;
          waterUsage.month = parsed.month || 0;
        } else {
          // Reset daily usage if it's a new day
          waterUsage.today = 0;
          waterUsage.week = parsed.week || 0;
          waterUsage.month = parsed.month || 0;
        }
        
        waterUsage.lastUpdated = today;
      }
      updateWaterUsageDisplay();
    }

    // Save water usage to localStorage
    function saveWaterUsage() {
      waterUsage.lastUpdated = new Date().toDateString();
      localStorage.setItem('waterUsage', JSON.stringify({
        today: waterUsage.today,
        week: waterUsage.week,
        month: waterUsage.month,
        lastUpdated: waterUsage.lastUpdated
      }));
    }

    // Update water usage display
    function updateWaterUsageDisplay() {
      document.getElementById('todayUsage').textContent = waterUsage.today.toFixed(1) + 'L';
      document.getElementById('weekUsage').textContent = waterUsage.week.toFixed(1) + 'L';
      document.getElementById('monthUsage').textContent = waterUsage.month.toFixed(1) + 'L';
      
      // Update progress bars (assuming 50L daily max, 350L weekly max, 1500L monthly max)
      document.getElementById('todayProgress').style.width = Math.min(waterUsage.today / 50 * 100, 100) + '%';
      document.getElementById('weekProgress').style.width = Math.min(waterUsage.week / 350 * 100, 100) + '%';
      document.getElementById('monthProgress').style.width = Math.min(waterUsage.month / 1500 * 100, 100) + '%';
    }

    // Track pump activity and calculate water usage
    function trackPumpActivity(isActive) {
      const now = new Date();
      
      if (isActive && !waterUsage.pumpActive) {
        // Pump just turned on
        waterUsage.pumpActive = true;
        waterUsage.pumpStartTime = now;
      } else if (!isActive && waterUsage.pumpActive) {
        // Pump just turned off - calculate usage
        waterUsage.pumpActive = false;
        if (waterUsage.pumpStartTime) {
          const duration = (now - waterUsage.pumpStartTime) / 60000; // minutes
          const usage = duration * waterUsage.flowRate;
          
          waterUsage.today += usage;
          waterUsage.week += usage;
          waterUsage.month += usage;
          
          updateWaterUsageDisplay();
          saveWaterUsage();
        }
      }
    }

    // Manual water now button
    document.getElementById('waterNowBtn').addEventListener('click', function() {
      // This would trigger an API call to activate the pump in a real implementation
      alert("Manual watering would be activated here. In this demo, it simulates 1 minute of watering.");
      
      // Simulate 1 minute of watering
      const usage = 1 * waterUsage.flowRate;
      waterUsage.today += usage;
      waterUsage.week += usage;
      waterUsage.month += usage;
      
      updateWaterUsageDisplay();
      saveWaterUsage();
    });

    // Check for saved theme preference
    const savedTheme = localStorage.getItem('theme');
    const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    let isDark = savedTheme ? savedTheme === 'dark' : systemPrefersDark;

    function applyTheme() {
      if (isDark) {
        body.setAttribute('data-theme', 'dark');
        themeIcon.className = 'bi bi-sun';
        localStorage.setItem('theme', 'dark');
      } else {
        body.removeAttribute('data-theme');
        themeIcon.className = 'bi bi-moon-stars';
        localStorage.setItem('theme', 'light');
      }
    }

    applyTheme();

    themeToggle.addEventListener('click', () => {
      isDark = !isDark;
      applyTheme();
    });

    // Welcome Message
    const welcomeMessage = document.getElementById('welcomeMessage');
    const hour = new Date().getHours();
    let greeting = 'Welcome';

    if (hour < 12) greeting = 'Good Morning';
    else if (hour < 18) greeting = 'Good Afternoon';
    else greeting = 'Good Evening';

    welcomeMessage.textContent = `${greeting}!`;

    // Watering tips based on time
    const wateringTip = document.getElementById('wateringTip');
    const tips = [
      "Water plants in the early morning to reduce evaporation.",
      "Check soil moisture before watering to avoid overwatering.",
      "Use mulch to retain soil moisture and reduce water needs.",
      "Water at the base of plants to minimize leaf wetness and disease.",
      "Adjust watering frequency based on seasonal weather changes."
    ];
    wateringTip.textContent = tips[Math.floor(Math.random() * tips.length)];

    // Load initial water usage
    loadWaterUsage();

    // Fetch Sensor Data
    async function fetchSensorData() {
      try {
        const token = 'ZLcZBsKlBLl8vq5YaSpvAezTnEMoOg2K';

        const [moistureRes, tempRes, humidityRes, pumpRes] = await Promise.all([
          fetch(`https://blynk.cloud/external/api/get?token=${token}&v0`),
          fetch(`https://blynk.cloud/external/api/get?token=${token}&v1`),
          fetch(`https://blynk.cloud/external/api/get?token=${token}&v2`),
          fetch(`https://blynk.cloud/external/api/get?token=${token}&D4`)
        ]);

        const soilMoisture = await moistureRes.text();
        const temperature = await tempRes.text();
        const humidity = await humidityRes.text();
        const pumpValue = await pumpRes.text();

        document.getElementById('soilMoisture').textContent = soilMoisture + '%';
        document.getElementById('temperature').textContent = temperature + 'Â°C';
        document.getElementById('humidity').textContent = humidity + '%';
        
        const pumpActive = pumpValue === "1";
        document.getElementById('pumpStatus').textContent = pumpActive ? "Active" : "Idle";
        
        // Track pump activity for water usage
        trackPumpActivity(pumpActive);

        const currentTime = new Date().toLocaleTimeString();
        document.getElementById('lastUpdated').textContent = currentTime;

      } catch (error) {
        console.error('Error fetching Blynk sensor data:', error);
      }
    }

    fetchSensorData();
    setInterval(fetchSensorData, 60000); // Update every 60 seconds
    
    // Reset daily usage at midnight
    function checkForDayChange() {
      const now = new Date();
      if (now.getHours() === 0 && now.getMinutes() === 0) {
        waterUsage.today = 0;
        updateWaterUsageDisplay();
        saveWaterUsage();
      }
    }
    setInterval(checkForDayChange, 60000); // Check every minute
  });
</script>
</body>
</html>
